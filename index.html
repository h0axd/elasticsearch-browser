<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Elasticsearch Data Browser</title>
<link rel="stylesheet" type="text/css" href="resources/ext-theme-neptune-all.css"/>
<script type="text/javascript" src="ext-all-debug.js"></script>
<script type="text/javascript" src="ext-theme-neptune.js"></script>
<style type="text/css">
    .x-grid-row .x-grid-cell-inner {
        white-space: normal;
    }

    .x-grid-row-over .x-grid-cell-inner {
        white-space: normal;
    }
</style>
<script type="text/javascript">

var GET = {};
window.location.href.replace(/[?&]+(table|database)=([a-z0-9][-a-z0-9\._\/]+)/gi, function (o, k, v) {
    GET[k] = v;
});
if (GET.database == undefined || GET.table == undefined) {
    document.write('Add to URL required parameters: <b>?database=[index]&table=[type]</b><br/>where<br/> [index] ElasticSearch index<br/> [type] ElasticSearch index type');
}

Ext.require([
    'Ext.data.*',
    'Ext.grid.*',
    'Ext.util.*',
    'Ext.tip.*',
    'Ext.chart.*'
]);

Ext.define('ES.data.proxy', {
    extend: 'Ext.data.proxy.Rest',

    fields: undefined,

    encodeFilters: function (filters) {
        var f = filters[0];
        return f.getValue();
    },

    encodeSorters: function (sorters) {
        var s = sorters[0];
        var esSort = {};
        esSort[s.getProperty()] = {order: s.getDirection().toLowerCase(), ignore_unmapped: true};
        return JSON.stringify(esSort);
    },

    doRequest: function (operation, callback, scope) {
        var request = this.buildRequest(operation, callback, scope);
        var params = request.getParams();

        // defaults
        var raw = {
            "_source": this.fields,
            "from": params.from,
            "size": params.size
        };
        // query
        raw['query'] = {
            "match_all": {}
        };
        if (params.query !== undefined) {
            raw['query'] = {
                "query_string": {
                    "default_operator": "AND",
                    "default_field": "_all",
                    "query": params.query
                }
            };
        }
        if (params.sort !== undefined) {
            raw['sort'] = JSON.parse(params.sort);
        }
        // facets
        //raw['facets'] = facetsConfig;

        request.setConfig({
            binary              : this.getBinary(),
            headers             : this.getHeaders(),
            timeout             : this.getTimeout(),
            scope               : scope,
            callback            : this.createRequestCallback(request, operation, callback, scope),
            method              : 'POST',
            disableCaching      : false
        });

        request.setJsonData(raw);
        request.setParams(undefined);

        if (this.getWithCredentials()) {
            request.setWithCredentials(true);
            request.setUsername(this.getUsername());
            request.setPassword(this.getPassword());
        }
        return this.sendRequest(request);
    }
});

Ext.define('Ext.ux.form.SearchField', {
    extend: 'Ext.form.field.Text',
    alias: 'widget.searchfield',
    triggers: {
        clear: {
            cls: Ext.baseCSSPrefix + 'form-clear-trigger',
            handler: function() { this.onTrigger1Click(); }
        },
        search: {
            cls: Ext.baseCSSPrefix + 'form-search-trigger',
            handler: function() { this.onTrigger2Click(); }
        }
    },
    hasSearch: false,
    paramName: 'query',
    initComponent: function () {
        var me = this;
        me.callParent(arguments);
        me.on('specialkey', function (f, e) {
            if (e.getKey() == e.ENTER) {
                if (me.getValue().trim() === "") me.onTrigger1Click();
                else me.onTrigger2Click();
            }
        });
        me.store.remoteFilter = true;
    },

    afterRender: function () {
        this.callParent();
        this.getTrigger('clear').hide();
    },

    onTrigger1Click: function () {
        var me = this;

        if (me.hasSearch) {
            me.setValue('');
            me.store.clearFilter();
            me.hasSearch = false;
            me.getTrigger('clear').hide();
            me.updateLayout();
        }
    },

    onTrigger2Click: function () {
        var me = this, value = me.getValue();
        if (value.length > 0) {
            me.store.clearFilter(true);
            me.store.addFilter({
                id: me.paramName,
                property: me.paramName,
                value: value
            });
            me.hasSearch = true;
            me.getTrigger('clear').show();
            me.updateLayout();
        }
    }
});

Ext.define('Ext.ux.grid.HeaderToolTip', {
    alias: 'plugin.headertooltip',
    init: function (grid) {
        var headerCt = grid.headerCt;
        grid.headerCt.on("afterrender", function (g) {
            grid.tip = Ext.create('Ext.tip.ToolTip', {
                target: headerCt.el,
                delegate: ".x-column-header",
                trackMouse: true,
                maxWidth: 800,
                maxHeight: 500,
                autoHide: false,
                listeners: {
                    beforeshow: function (tip) {
                        var c = headerCt.down('gridcolumn[id=' + tip.triggerElement.id + ']');
                        if (c && c.tooltip) {
                            tip.items.replace(0, c.tooltip);
                        } else {
                            return false;
                        }
                    }
                }
            });
        });
    }
});


Ext.onReady(function () {
    var grid = {};
    var dataStore = {};
    var browserPort = (window.location.port) ? window.location.port : 9200;

    var columnModel = [];
    var fieldModel = [];
    var fieldList = [];
    var aggregations = {};
    
    var indexStore = Ext.create('Ext.data.Store', {
        autoLoad: true,
        fields: [
            { name: 'id', unique: true },
            { name: 'docs', type: 'int' }
        ],
        proxy: {
            type: 'rest',
            filterParam: undefined,
            groupParam: undefined,
            pageParam: undefined,
            startParam: undefined,
            sortParam: undefined,
            limitParam: undefined,
            timeout: 20000,
            url: 'http://localhost:' + browserPort + '/_stats/docs',
            appendId: false,
            noCache: false,
            reader: {
                type: 'json',
                transform: {
                    fn: function (data) {
                        var a = [];
                        for (var p in data.indices) {
                            a.push({id: p, docs: data.indices[p].total.docs.count});
                        }
                        return a;
                    }
                }
            }
        },
        listeners: {
            load: function () {
                console.log("Indices list loaded:", this.getData());
            }
        }
    });
 
    var schemaStore = Ext.create('Ext.data.Store', {
        autoLoad: true,
        fields: [
            {
                name: 'type'
            }
        ],
        proxy: {
            type: 'rest',
            filterParam: undefined,
            groupParam: undefined,
            pageParam: undefined,
            startParam: undefined,
            sortParam: undefined,
            limitParam: undefined,
            appendId: false,
            noCache: false,
            //url: window.location.protocol + '//' + window.location.hostname + ':' + browserPort + '/' + encodeURIComponent(GET.database) + '/' + encodeURIComponent(GET.table) + '/' + '_mapping',
            url: 'http://localhost:' + browserPort + '/' + encodeURIComponent(GET.database) + '/' + encodeURIComponent(GET.table) + '/' + '_mapping',
            reader: {
                type: 'json',
                transform: {
                    fn: function (data) {
                        var processDictionary = function (dictionary, prefix) {
                            for (p in dictionary) {
                                if (!dictionary.hasOwnProperty(p)) continue;
                                var type = dictionary[p].type;
                                var xtype = 'textfield';
                                if (!type || typeof type !== "string" || type === "object") {
                                    var newPrefix = p === "properties" ? prefix : (prefix ? prefix + "." + p : p);
                                    if (newPrefix && newPrefix.replace(/[^.]/g, "").length > 1) continue; // limit nesting
                                    processDictionary(dictionary[p], newPrefix);
                                    continue;
                                }
                                // prefixedProp
                                var pp = prefix ? prefix + "." + p : p;
                                switch (type) {
                                    case 'float':
                                    case 'double':
                                    case 'integer':
                                    case 'long':
                                    case 'short':
                                    case 'byte':
                                        type = 'int';
                                        xtype = 'numberfield';
                                        aggregations[pp] = {"extended_stats": {"field": pp}};
                                        break;
                                    case 'date':
                                        xtype = 'datefield';
                                        var d = new Date();
                                        var n = d.getTimezoneOffset();
                                        aggregations[pp] = {"date_histogram": {"field": pp, "interval": "hour", "post_zone": n / 60}};
                                        break;
                                    case 'boolean':
                                        xtype = 'checkbox';
                                        aggregations[pp] = {"terms": {"field": pp, "size": 3}};
                                        break;
                                    case 'string':
                                        xtype = 'textfield';
                                        aggregations[pp] = {"terms": {"field": pp, "size": 7}};
                                        break;
                                    default:
                                        xtype = 'textfield';
                                        break;
                                }
                                columnModel.push({
                                    text: pp,
                                    dataIndex: pp
                                });
                                fieldModel.push({
                                    name: pp,
                                    type: type
                                });
                                fieldList.push(pp);
                            }
                        };
                        var newRoot = {
                            total: 1,
                            root: data[GET.database].mappings[GET.table].properties
                        };
                        processDictionary(newRoot.root, null);
                        return newRoot;
                    }
                }
            }
        },
        listeners: {
            load: function () {
                try {
                    if (columnModel.length === 0) {
                        throw new Error("Mappings couldn't be loaded");
                    }

                    dataStore.setFields(fieldModel);
                    grid.unmask();
                    dataStore.setAutoLoad(true);
                    grid.reconfigure(dataStore, columnModel);
                } catch(err) {
                    Ext.MessageBox.show({
                        title: "Error processing mapping",
                        msg: err,
                        buttons: Ext.MessageBox.OK,
                        icon: Ext.MessageBox['ERROR']
                    });
                    grid.disable();
                }
            }
        }
    });
 
    dataStore = Ext.create('Ext.data.Store', {
        autoLoad: false,
        fields: [],
        remoteSort: true,
        buffered: true,
        pageSize: 100,
        leadingBufferZone: 100,
        proxy: Ext.create('ES.data.proxy', {
            filterParam: 'query',
            limitParam: 'size',
            startParam: 'from',
            sortParam: 'sort',
            //url: window.location.protocol + '//' + window.location.hostname + ':' + browserPort + '/' + encodeURIComponent(GET.database) + '/' + encodeURIComponent(GET.table) + '/' + '_search?track_scores=false',
            url: 'http://localhost:' + browserPort + '/' + encodeURIComponent(GET.database) + '/' + encodeURIComponent(GET.table) + '/' + '_search?&track_scores=false',
            appendId: false,
            noCache: false,
            fields: fieldList,
            reader: {
                type: 'json',
                rootProperty: 'hits.hits',
                record: '_source',
                totalProperty: 'hits.total'
            },
        }),
        simpleSortMode: true,
        remoteFilter: true,
        listeners: {
            totalcountchange: function () {
                grid.down('#status').update({count: dataStore.getTotalCount()});

                return;
                if (dataStore.proxy.reader.jsonData.facets === undefined)
                    return;

                for (i in grid.columns) {
                    if (dataStore.proxy.reader.jsonData.facets[grid.columns[i].dataIndex] !== undefined) {
                        var facet = dataStore.proxy.reader.jsonData.facets[grid.columns[i].dataIndex];
                        switch (facet._type) {
                            case 'terms':
                                if (facet.other > 0)
                                    facet.terms.push({'term': 'Other', 'count': facet.other})
                                grid.columns[i].tooltip = Ext.create('Ext.chart.Chart', {
                                    frame: true,
                                    floating: false,
                                    width: 280,
                                    height: 320,
                                    legend: true,
                                    animate: false,
                                    store: Ext.create('Ext.data.Store', {
                                        fields: ['term', 'count'],
                                        data: facet.terms
                                    }),
                                    shadow: false,
                                    insetPadding: 20,
                                    series: [
                                        {
                                            type: 'pie',
                                            field: 'count',
                                            highlight: true,
                                            showInLegend: true,
                                            label: {
                                                field: 'term',
                                                display: 'rotate',
                                                contrast: true
                                            }
                                        }
                                    ]
                                });
                                break;
                            case 'statistical':
                                grid.columns[i].tooltip = Ext.create('Ext.Component', {
                                    html: 'Count: ' + facet.count + '<br/>' +
                                            'Sum: ' + facet.total + '<br/>' +
                                            'Minimum: ' + facet.min + '<br/>' +
                                            'Maximum: ' + facet.max + '<br/>' +
                                            'Average: ' + facet.mean + '<br/>' +
                                            'Variance: ' + facet.variance + '<br/>' +
                                            'Sum of squares: ' + facet.sum_of_squares + '<br/>' +
                                            'Deviation: ' + facet.std_deviation,
                                    padding: 5,
                                    width: 200,
                                    style: {
                                        'font-size': '1.2em'
                                    },
                                    frame: true
                                });
                                break;
                            case 'date_histogram':
                                grid.columns[i].tooltip = Ext.create('Ext.chart.Chart', {
                                    frame: true,
                                    floating: false,
                                    width: 500,
                                    height: 320,
                                    legend: false,
                                    animate: false,
                                    store: Ext.create('Ext.data.Store', {
                                        fields: ['time', 'count'],
                                        data: facet.entries
                                    }),
                                    shadow: false,
                                    insetPadding: 20,
                                    axes: [
                                        {
                                            type: 'Numeric',
                                            position: 'left',
                                            fields: ['count'],
                                            title: 'Records',
                                            grid: true,
                                            minimum: 0
                                        },
                                        {
                                            type: 'Category',
                                            position: 'bottom',
                                            fields: ['time'],
                                            label: {
                                                renderer: function (v) {
                                                    return Ext.Date.format(new Date(v), 'Y-m-d h:i');
                                                }
                                            },
                                            title: 'Hour'
                                        }
                                    ],
                                    series: [
                                        {
                                            type: 'column',
                                            axis: 'left',
                                            xField: 'time',
                                            yField: 'count',
                                            label: {
                                                field: 'count',
                                                display: 'insideEnd',
                                                orientation: 'vertical'
                                            }
                                        }
                                    ]
                                });
                                break;
                        }
                    }
                }
                ;
            },
            load : function(ref, records, successful, opts) {
                console.log("LOADED store", successful ? "successfully" : "with error");
            }
        }
    });

    grid = Ext.create('Ext.grid.Panel', {
        renderTo: document.body,
        viewConfig: {
            enableTextSelection: true
        },
        stateful: true,
        height: (window.innerWidth !== undefined) ?
                window.innerHeight : Math.max(document.documentElement.clientHeight, document.body.clientHeight),
        frame: false,
        title: GET.table.charAt(0).toUpperCase() + GET.table.slice(1),
        columns: [],
        store: dataStore,
        disableSelection: true,
        plugins: ['headertooltip'],
        dockedItems: [
            {
                dock: 'top',
                xtype: 'toolbar',
                items: [
                    {
                        width: 500,
                        labelWidth: 50,
                        fieldLabel: 'Search',
                        itemId: 'search',
                        emptyText: 'keyword OR AND NOT () field:value...',
                        xtype: 'searchfield',
                        store: dataStore
                    },
                    '->',
                    {
                        xtype: 'component',
                        itemId: 'status',
                        tpl: 'Matching records: {count}',
                        style: 'margin-right:5px'
                    }
                ]
            }
        ]
    });
    grid.mask("Loading data mappings...");
});

</script>
</head>
<body>
</body>
</html>
